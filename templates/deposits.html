{% extends 'base.html' %}
{% load currency_filters %}

{% block title %}Deposits - Tesla Investment Platform{% endblock %}

{% block content %}
<div class="space-y-8 px-4 md:px-0">
    <h1 class="text-4xl md:text-5xl font-bold text-gray-900">Deposit Funds</h1>

    <!-- Alert Messages (hidden, will trigger modal) -->
    {% if success %}
    <div id="alert-success-msg" style="display:none">{{ success }}</div>
    {% endif %}
    
    {% if error %}
    <div id="alert-error-msg" style="display:none">{{ error }}</div>
    {% endif %}

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Deposit Form -->
        <div class="bg-white rounded-lg shadow-2xl p-6 border border-gray-300">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Submit Deposit</h2>

            <form id="deposit-form" method="post" action="/deposits/" onsubmit="return handleDepositSubmit()" class="space-y-4">
                {% csrf_token %}
                
                <div>
                    <label for="cryptocurrency" class="block text-sm font-medium text-gray-700 mb-2">Select Cryptocurrency</label>
                    <select id="cryptocurrency" name="cryptocurrency" required onchange="updateWallet()" class="w-full px-4 py-3 bg-white border border-gray-300 text-gray-900 rounded-lg focus:ring-2 focus:ring-blue-600 transition">
                        <option value="">Choose a cryptocurrency...</option>
                        {% for wallet in wallets %}
                        <option value="{{ wallet.cryptocurrency }}" data-address="{{ wallet.wallet_address }}">
                            {{ wallet.get_cryptocurrency_display }} ({{ wallet.cryptocurrency }})
                        </option>
                        {% endfor %}
                    </select>
                    <p class="text-sm text-gray-600 mt-1">Select the cryptocurrency you sent</p>
                </div>

                <div id="selected-wallet" class="mt-4 hidden" aria-live="polite">
                    <div class="bg-white border border-gray-300 rounded-lg p-4">
                        <h4 class="font-bold text-gray-900 mb-2">Receiving Address</h4>
                        <p id="selected-wallet-address" class="text-gray-600 break-all text-sm mb-3 font-mono">Choose a cryptocurrency to reveal the receiving address.</p>
                        <button type="button" id="copy-selected-wallet" class="hidden bg-white hover:bg-blue-700 text-black px-3 py-1 rounded text-sm transition font-semibold" onclick="copyAddress()">Copy Address</button>
                    </div>
                </div>

                <div>
                    <label for="amount" class="block text-sm font-medium text-gray-700 mb-2">Amount in {{ currency_symbol }}</label>
                    <div class="flex gap-2">
                        <input type="number" id="amount" name="amount" step="0.01" min="0" max="{{ balance|convert_currency:exchange_rate }}" required class="flex-1 px-4 py-3 bg-white border border-gray-300 text-gray-900 rounded-lg focus:ring-2 focus:ring-blue-600 transition placeholder-gray-500" placeholder="Enter amount in {{ currency_symbol }}" onchange="convertToCrypto()" oninput="convertToCrypto()">
                    </div>
                    <p class="text-sm text-gray-600 mt-2">Max available: {% currency_display balance %}</p>
                </div>

                <div id="crypto-conversion" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p class="text-sm text-gray-700"><strong>Crypto Amount:</strong> <span id="crypto-amount-display">0.00000000</span> <span id="selected-crypto">BTC</span></p>
                    <p class="text-xs text-gray-600 mt-1">Exchange rate: 1 USD = {{ exchange_rate }} {{ currency_symbol }}</p>
                </div>

                <div>
                    <label for="proof_type" class="block text-sm font-medium text-gray-700 mb-2">Proof Type</label>
                    <select id="proof_type" name="proof_type" required class="w-full px-4 py-3 bg-white border border-gray-300 text-gray-900 rounded-lg focus:ring-2 focus:ring-blue-600 transition">
                        <option value="">Select proof type...</option>
                        <option value="transaction_id">Transaction ID</option>
                        <option value="screenshot">Screenshot</option>
                        <option value="note">Note</option>
                    </select>
                </div>

                <div id="proof-content-group">
                    <label for="proof_content" class="block text-sm font-medium text-gray-700 mb-2">Proof Content</label>
                    <textarea id="proof_content" name="proof_content" rows="3" class="w-full px-4 py-3 bg-white border border-gray-300 text-gray-900 rounded-lg focus:ring-2 focus:ring-blue-600 transition placeholder-gray-500"></textarea>
                </div>

                <div id="proof-image-group" class="hidden">
                    <label for="proof_image" class="block text-sm font-medium text-gray-700 mb-2">Upload Screenshot</label>
                    <input type="file" id="proof_image" name="proof_image" accept="image/*" class="w-full px-4 py-3 bg-white border border-gray-300 text-gray-600 rounded-lg">
                </div>

                <button type="submit" class="w-full bg-white hover:bg-blue-700 text-black font-bold py-3 px-4 rounded-lg transition">
                    Submit Deposit
                </button>
            </form>
        </div>
        <!-- Recent Deposits -->
        <div class="bg-white rounded-lg shadow-2xl p-6 border border-gray-300">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Your Deposits</h2>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="border-b border-gray-300">
                        <tr class="text-gray-700">
                            <th class="text-left py-2">Date</th>
                            <th class="text-left py-2">Cryptocurrency</th>
                            <th class="text-right py-2">Amount</th>
                            <th class="text-center py-2">Status</th>
                        </tr>
                    </thead>
                    <tbody id="deposits-table" class="divide-y divide-gray-300">
                        {% if deposits %}
                            {% for deposit in deposits %}
                            <tr class="hover:bg-white transition">
                                <td class="py-2 text-gray-600">{{ deposit.created_at|date:"M d, Y H:i" }}</td>
                                <td class="py-2 text-gray-600">{{ deposit.cryptocurrency }}</td>
                                <td class="py-2 text-right font-mono text-gray-600">{{ deposit.amount|floatformat:8 }}</td>
                                <td class="py-2 text-center">
                                    <span class="text-xs font-bold px-2 py-1 rounded-full {% if deposit.status == 'approved' %}bg-green-100 text-green-800{% elif deposit.status == 'pending' %}bg-yellow-100 text-yellow-800{% elif deposit.status == 'rejected' %}bg-red-100 text-red-800{% else %}bg-gray-100 text-gray-700{% endif %}">
                                        {{ deposit.get_status_display }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr><td colspan="4" class="py-4 text-center text-gray-600">No deposits yet</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
function updateWallet() {
    const select = document.getElementById('cryptocurrency');
    const option = select.options[select.selectedIndex];
    const address = option.getAttribute('data-address');
    const walletDiv = document.getElementById('selected-wallet');
    const addressEl = document.getElementById('selected-wallet-address');
    const copyBtn = document.getElementById('copy-selected-wallet');
    
    if (address) {
        walletDiv.classList.remove('hidden');
        addressEl.textContent = address;
        copyBtn.classList.remove('hidden');
    } else {
        walletDiv.classList.add('hidden');
        addressEl.textContent = 'Choose a cryptocurrency to reveal the receiving address.';
        copyBtn.classList.add('hidden');
    }
    
    // Recalculate crypto amount when cryptocurrency changes
    convertToCrypto();
}

function copyAddress() {
    const address = document.getElementById('selected-wallet-address').textContent;
    navigator.clipboard.writeText(address).then(() => {
        alert('Address copied to clipboard!');
    });
}

function convertToCrypto() {
    const amountInput = document.getElementById('amount');
    const cryptoSelect = document.getElementById('cryptocurrency');
    const conversionDiv = document.getElementById('crypto-conversion');
    const cryptoAmountDisplay = document.getElementById('crypto-amount-display');
    const selectedCryptoSpan = document.getElementById('selected-crypto');
    
    const amount = parseFloat(amountInput.value);
    const selectedCrypto = cryptoSelect.value;
    
    if (!amount || amount <= 0 || !selectedCrypto) {
        conversionDiv.classList.add('hidden');
        return;
    }
    
    // Exchange rates from template context
    const exchangeRate = parseFloat('{{ exchange_rate }}');
    const cryptoPrices = {{ crypto_prices|safe }};
    
    if (!cryptoPrices[selectedCrypto]) {
        conversionDiv.classList.add('hidden');
        return;
    }
    
    // Conversion: Platform Currency → USD → Crypto
    // Step 1: Convert platform currency to USD
    const usdAmount = amount / exchangeRate;
    
    // Step 2: Convert USD to crypto
    const cryptoPrice = parseFloat(cryptoPrices[selectedCrypto]);
    const cryptoAmount = usdAmount / cryptoPrice;
    
    // Format to 8 decimal places
    cryptoAmountDisplay.textContent = cryptoAmount.toFixed(8);
    selectedCryptoSpan.textContent = selectedCrypto;
    conversionDiv.classList.remove('hidden');
    
    // Store the calculated amount in the hidden form field or directly in the amount field
    amountInput.dataset.cryptoAmount = cryptoAmount.toFixed(8);
}

function handleDepositSubmit() {
    const amountInput = document.getElementById('amount');
    const currencyAmount = parseFloat(amountInput.value);

    if (!currencyAmount || currencyAmount <= 0) {
        alert('Please enter a valid amount');
        return false;
    }

    // Allow normal form submission; server will render alert divs
    return true;
}

// Complete inline modal implementation
function showInlineAlert(message, type) {
    const colors = {
        success: { bg: '#f0fdf4', border: '#86efac', text: '#166534', btn: '#16a34a' },
        error: { bg: '#fef2f2', border: '#fca5a5', text: '#7f1d1d', btn: '#dc2626' }
    };
    const c = colors[type] || colors.success;
    
    const container = document.createElement('div');
    container.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10000';
    
    const box = document.createElement('div');
    box.style.cssText = `background:${c.bg};border:2px solid ${c.border};border-radius:12px;padding:32px;max-width:500px;width:90%;text-align:center;box-shadow:0 20px 25px rgba(0,0,0,0.1)`;
    
    const title = type === 'success' ? 'Success' : 'Error';
    box.innerHTML = `
        <h2 style="color:${c.text};font-size:24px;font-weight:bold;margin:0 0 16px 0">${title}</h2>
        <p style="color:#374151;font-size:16px;margin:0 0 24px 0;line-height:1.5">${message}</p>
        <button id="alert-ok-btn" style="background:${c.btn};color:white;border:none;padding:12px 32px;border-radius:8px;font-weight:bold;cursor:pointer;font-size:16px;width:100%">OK</button>
    `;
    
    container.appendChild(box);
    document.body.appendChild(container);
    
    document.getElementById('alert-ok-btn').onclick = function() { container.remove(); };
    container.onclick = function(e) { if (e.target === container) container.remove(); };
}

document.addEventListener('DOMContentLoaded', function() {
    const successDiv = document.getElementById('alert-success-msg');
    const errorDiv = document.getElementById('alert-error-msg');
    
    if (successDiv && successDiv.textContent.trim()) {
        showInlineAlert(successDiv.textContent.trim(), 'success');
        successDiv.remove();
    } else if (errorDiv && errorDiv.textContent.trim()) {
        showInlineAlert(errorDiv.textContent.trim(), 'error');
        errorDiv.remove();
    }
});
</script>
{% endblock %}
