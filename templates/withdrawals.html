{% extends 'base.html' %}
{% load currency_filters %}

{% block title %}Withdrawals - Tesla Investment Platform{% endblock %}

{% block content %}
<div class="space-y-8 px-4 md:px-0">
    <!-- Header -->
    <div>
        <h1 class="text-4xl md:text-5xl font-bold text-gray-900">Withdraw Funds</h1>
        <p class="text-gray-600 mt-2">Request a withdrawal from your account balance</p>
    </div>

    <!-- Alert Messages (hidden, will trigger modal) -->
    {% if success %}
    <div id="alert-success-msg" style="display:none">{{ success }}</div>
    {% endif %}
    
    {% if error %}
    <div id="alert-error-msg" style="display:none">{{ error }}</div>
    {% endif %}

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
        <!-- Withdrawal Form -->
        <div class="bg-white rounded-lg shadow-2xl p-6 border border-gray-300">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Request Withdrawal</h2>
            <form id="withdrawal-form" method="post" action="/withdrawals/" class="space-y-5">
                {% csrf_token %}
                <div>
                    <label for="amount" class="block text-sm font-semibold text-gray-700 mb-2">Amount <span class="text-red-600">*</span></label>
                    <input type="number" class="w-full px-4 py-3 bg-white border border-gray-300 text-gray-900 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-500 transition" id="amount" name="amount" step="0.01" min="0" max="{{ balance }}" required>
                    <p class="text-sm text-gray-600 mt-2">Available balance: <span class="font-semibold text-gray-900">{% currency_display balance %}</span></p>
                </div>

                <div>
                    <label for="cryptocurrency" class="block text-sm font-semibold text-gray-700 mb-2">Cryptocurrency <span class="text-red-600">*</span></label>
                    <select class="w-full px-4 py-3 bg-white border border-gray-300 text-gray-900 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" id="cryptocurrency" name="cryptocurrency" required>
                        <option value="">Select a cryptocurrency...</option>
                        <option value="BTC">Bitcoin (BTC)</option>
                        <option value="ETH">Ethereum (ETH)</option>
                        <option value="USDT-ERC20">USDT ERC-20 (Ethereum)</option>
                        <option value="USDT-TRC20">USDT TRC-20 (Tron)</option>
                        <option value="USDT-BEP20">USDT BEP-20 (Binance)</option>
                        <option value="USDC">USD Coin (USDC)</option>
                        <option value="BNB">Binance Coin (BNB)</option>
                        <option value="LTC">Litecoin (LTC)</option>
                        <option value="XRP">Ripple (XRP)</option>
                        <option value="ADA">Cardano (ADA)</option>
                    </select>
                </div>

                <div>
                    <label for="wallet_address" class="block text-sm font-semibold text-gray-700 mb-2">Wallet Address <span class="text-red-600">*</span></label>
                    <input type="text" class="w-full px-4 py-3 bg-white border border-gray-300 text-gray-900 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-500 transition font-mono text-sm" id="wallet_address" name="wallet_address" placeholder="Enter your wallet address" required>
                    <p class="text-xs text-gray-600 mt-1">Double-check the address - withdrawals cannot be reversed</p>
                </div>

                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition shadow-md">
                    Request Withdrawal
                </button>
            </form>
        </div>

        <!-- Withdrawal Info -->
        <div class="bg-white rounded-lg shadow-2xl p-6 border border-gray-300">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Withdrawal Information</h2>
            <div class="space-y-4">
                <div class="flex items-start gap-3">
                    <svg class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                    <div>
                        <p class="font-semibold text-gray-900">Minimum Withdrawal</p>
                        <p class="text-sm text-gray-600">$10.00 USD</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <svg class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v3.586L7.707 9.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 10.586V7z" clip-rule="evenodd"/>
                    </svg>
                    <div>
                        <p class="font-semibold text-gray-900">Processing Time</p>
                        <p class="text-sm text-gray-600">2-5 business days</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <svg class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 3.062v6.727a1 1 0 01-.978.997h-.004c-.374 0-.742-.991-.868-2.126a6.75 6.75 0 00-.364-1.629A2.25 2.25 0 0015 12.224v-3.772a2.25 2.25 0 00-2.25-2.25h-2.5a2.25 2.25 0 00-2.25 2.25v3.772c0 .881-.451 1.694-1.136 2.167-.366.277-.766.643-.982 1.159-.216.516-.479 1.597-.868 2.126A1 1 0 0110 18.057v.001h-.004a3.066 3.066 0 01-2.812-3.062v-6.727c0-1.066-.34-2.058-.967-2.893a3.066 3.066 0 011.276-1.127z" clip-rule="evenodd"/>
                    </svg>
                    <div>
                        <p class="font-semibold text-gray-900">Admin Approval Required</p>
                        <p class="text-sm text-gray-600">All withdrawals must be reviewed and approved</p>
                    </div>
                </div>
                <div class="border-t border-gray-300 pt-4 mt-4">
                    <p class="text-sm text-gray-600">⚠️ Double-check wallet addresses before submitting. Withdrawals to incorrect addresses cannot be recovered.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Withdrawal History -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
        <div class="px-4 md:px-6 py-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
                    <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Recent Withdrawals
                </h2>
                <span class="text-sm text-gray-600 bg-gray-100 px-4 py-2 rounded-full font-medium">Last 3</span>
            </div>
        </div>
        
        {% if withdrawals %}
        <!-- Desktop Table View -->
        <div class="hidden md:block overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-gradient-to-r from-blue-600 to-blue-700">
                    <tr>
                        <th class="px-4 md:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Date</th>
                        <th class="px-4 md:px-6 py-4 text-right text-xs font-bold text-white uppercase tracking-wider">Amount</th>
                        <th class="px-4 md:px-6 py-4 text-center text-xs font-bold text-white uppercase tracking-wider">Cryptocurrency</th>
                        <th class="px-4 md:px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Wallet Address</th>
                        <th class="px-4 md:px-6 py-4 text-center text-xs font-bold text-white uppercase tracking-wider">Status</th>
                    </tr>
                </thead>
                <tbody id="withdrawals-table" class="divide-y divide-gray-200 bg-white">
                    {% for withdrawal in withdrawals %}
                    <tr class="hover:bg-blue-50 transition-colors duration-200">
                        <td class="px-4 md:px-6 py-4 text-gray-600 text-xs md:text-sm whitespace-nowrap font-semibold">{{ withdrawal.created_at|date:"M d, Y" }}</td>
                        <td class="px-4 md:px-6 py-4 text-right font-bold text-gray-900 text-xs md:text-sm whitespace-nowrap">${{ withdrawal.amount|floatformat:2 }}</td>
                        <td class="px-4 md:px-6 py-4 text-center text-gray-700 text-xs md:text-sm font-semibold whitespace-nowrap">{{ withdrawal.cryptocurrency }}</td>
                        <td class="px-4 md:px-6 py-4 font-mono text-xs text-gray-600 max-w-xs truncate">{{ withdrawal.wallet_address }}</td>
                        <td class="px-4 md:px-6 py-4 text-center">
                            <span class="text-xs font-bold px-3 py-1.5 rounded-full
                                {% if withdrawal.status == 'completed' %}bg-green-100 text-green-800
                                {% elif withdrawal.status == 'pending' %}bg-yellow-100 text-yellow-800
                                {% elif withdrawal.status == 'processing' %}bg-blue-100 text-blue-800
                                {% elif withdrawal.status == 'rejected' %}bg-red-100 text-red-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ withdrawal.get_status_display }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Mobile Card View -->
        <div class="md:hidden p-4 space-y-4">
            {% for withdrawal in withdrawals %}
            <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                <div class="flex items-start justify-between mb-3">
                    <div>
                        <p class="text-xs text-gray-600 font-semibold uppercase">Date</p>
                        <p class="text-lg font-bold text-gray-900">{{ withdrawal.created_at|date:"M d, Y" }}</p>
                    </div>
                    <span class="text-xs font-bold px-3 py-1.5 rounded-full
                        {% if withdrawal.status == 'completed' %}bg-green-100 text-green-800
                        {% elif withdrawal.status == 'pending' %}bg-yellow-100 text-yellow-800
                        {% elif withdrawal.status == 'processing' %}bg-blue-100 text-blue-800
                        {% elif withdrawal.status == 'rejected' %}bg-red-100 text-red-800
                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ withdrawal.get_status_display }}
                    </span>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div class="bg-gray-50 rounded-lg p-3">
                        <p class="text-xs text-gray-600 font-semibold mb-1">Amount</p>
                        <p class="text-lg font-bold text-gray-900">${{ withdrawal.amount|floatformat:2 }}</p>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3">
                        <p class="text-xs text-gray-600 font-semibold mb-1">Cryptocurrency</p>
                        <p class="text-lg font-bold text-gray-900">{{ withdrawal.cryptocurrency }}</p>
                    </div>
                </div>

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p class="text-xs text-gray-600 font-semibold mb-1">Wallet Address</p>
                    <p class="text-xs font-mono text-gray-700 break-all">{{ withdrawal.wallet_address }}</p>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-16">
            <div class="bg-gray-100 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-4">
                <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
            </div>
            <p class="text-gray-900 text-lg font-bold mb-1">No Withdrawals Yet</p>
            <p class="text-gray-500 text-sm">Your withdrawal requests will appear here</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
function showInlineAlert(message, type) {
    const colors = {
        success: { bg: '#f0fdf4', border: '#86efac', text: '#166534', btn: '#16a34a' },
        error: { bg: '#fef2f2', border: '#fca5a5', text: '#7f1d1d', btn: '#dc2626' }
    };
    const c = colors[type] || colors.success;
    
    const container = document.createElement('div');
    container.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10000';
    
    const box = document.createElement('div');
    box.style.cssText = `background:${c.bg};border:2px solid ${c.border};border-radius:12px;padding:32px;max-width:500px;width:90%;text-align:center;box-shadow:0 20px 25px rgba(0,0,0,0.1)`;
    
    const title = type === 'success' ? 'Success' : 'Error';
    box.innerHTML = `
        <h2 style="color:${c.text};font-size:24px;font-weight:bold;margin:0 0 16px 0">${title}</h2>
        <p style="color:#374151;font-size:16px;margin:0 0 24px 0;line-height:1.5">${message}</p>
        <button id="alert-ok-btn" style="background:${c.btn};color:white;border:none;padding:12px 32px;border-radius:8px;font-weight:bold;cursor:pointer;font-size:16px;width:100%">OK</button>
    `;
    
    container.appendChild(box);
    document.body.appendChild(container);
    
    document.getElementById('alert-ok-btn').onclick = function() { container.remove(); };
    container.onclick = function(e) { if (e.target === container) container.remove(); };
}

document.addEventListener('DOMContentLoaded', function() {
    const successDiv = document.getElementById('alert-success-msg');
    const errorDiv = document.getElementById('alert-error-msg');
    
    if (successDiv && successDiv.textContent.trim()) {
        showInlineAlert(successDiv.textContent.trim(), 'success');
        successDiv.remove();
    } else if (errorDiv && errorDiv.textContent.trim()) {
        showInlineAlert(errorDiv.textContent.trim(), 'error');
        errorDiv.remove();
    }
});
</script>

{% endblock %}
